/*
 * generated by Xtext
 */
package xtraitj.scoping

import com.google.inject.Inject
import org.eclipse.emf.ecore.EObject
import org.eclipse.emf.ecore.EReference
import org.eclipse.xtext.naming.QualifiedName
import org.eclipse.xtext.scoping.IScope
import org.eclipse.xtext.scoping.impl.SimpleScope
import xtraitj.jvmmodel.XtraitjJvmModelHelper
import xtraitj.jvmmodel.XtraitjJvmModelUtil
import xtraitj.xtraitj.TJTraitOperation
import xtraitj.xtraitj.TJTraitOperationForProvided
import xtraitj.xtraitj.XtraitjPackage

import static extension org.eclipse.xtext.scoping.Scopes.*

/**
 * For the moment Xbase uses two different scope providers, one for
 * the runtime part and one for the content assist, thus we must
 * factor out commong behavior.
 * 
 * see http://www.eclipse.org/forums/index.php/mv/msg/476486/1041675/#msg_1041675
 *
 */
class XtraitjScopeProviderUtil {
	@Inject extension XtraitjJvmModelUtil
	@Inject extension XtraitjJvmModelHelper

	def IScope createCustomScope(EObject context, EReference reference) {
		if (reference == XtraitjPackage::eINSTANCE.TJTraitOperation_Member ||
			reference == XtraitjPackage::eINSTANCE.TJRedirectOperation_Member2
		) {
			return context.customScope
		}

		return null;
	}

	def dispatch customScope(EObject op) {
		IScope::NULLSCOPE
	}

	def dispatch customScope(TJTraitOperation op) {
		val ops = getXtraitjResolvedOperations(op)
		
		// a JvmMember does not have 'name', but 'simpleName'
		// thus we must also provide a function for computing the
		// QualifiedName (the default one relies on 'name')
		return new SimpleScope(
			ops.requiredFields.map[getOp].scopedElementsFor [
				QualifiedName::create(simpleName.stripGetter)
			] +
			ops.declaredMethods.map[getOp].scopedElementsFor [
				QualifiedName::create(simpleName)
			]
		)
	}
	
	def dispatch customScope(TJTraitOperationForProvided op) {
		return scopeForDefinedMethods(op)
	}

	def scopeForDefinedMethods(TJTraitOperation op) {
		new SimpleScope(
			getXtraitjResolvedOperations(op).
				declaredMethods.
				map[getOp].
				scopedElementsFor [
					QualifiedName::create(simpleName)
				]
		)
	}
}
